---
title: "Payments Overview"
description: "Comprehensive payment system with Stripe integration, entitlements, and usage tracking"
---

# Payments System

Launch includes a complete payment system designed to handle subscriptions, usage-based billing, and entitlements. The system is built with flexibility in mind, supporting multiple monetization patterns while maintaining a clean separation between payment providers and business logic.

## Architecture Overview

The payment system follows a **Plans â†’ Entitlements â†’ Meters** architecture that provides:

- **Generic Design**: Not tied to specific payment providers
- **Flexible Entitlements**: Easy feature access control
- **Usage Tracking**: Built-in metering for any feature
- **Multiple Billing Models**: Subscriptions, usage-based, and one-time payments

## Core Concepts

### Plans

Plans define what users pay for - Free, Pro Monthly, Pro Yearly, etc. Each plan maps to Stripe products and prices but can work with other payment providers.

**Database Model**: `Plan` in `apps/api/prisma/schema.prisma`

### Entitlements

Entitlements define what features users get access to. Examples:

- `pro_docs` - Access to premium document features
- `ai_pro` - Advanced AI capabilities
- `unlimited_uploads` - Remove upload restrictions

**Database Models**: `Entitlement`, `PlanEntitlement`, `UserEntitlement`

### Meters

Meters track usage of specific features with configurable limits and reset periods.

- `docs.uploads.month` - Monthly document upload counter
- `ai.tokens.month` - Monthly AI token usage
- `storage.bytes.total` - Total storage used

**Database Models**: `Meter`, `UsageCounter`

## Implementation Status

### âœ… Completed

- **Database Schema**: Complete payment models with Stripe customer ID integration
- **Feature Catalog UI**: Explore tab with Stripe provider card and status detection
- **Stripe Integration**: Full API setup with payment intents, checkout sessions, and webhooks
- **Customer Management**: Automatic Stripe customer creation with user name/email
- **Webhook Handling**: Complete event processing for all payment scenarios
- **Mobile PaymentSheet**: Test payment flows with proper error handling
- **Documentation**: Comprehensive setup guide with ngrok and troubleshooting

### ðŸš§ In Progress

- **tRPC Middlewares**: Entitlement and usage checking
- **Usage Tracking**: Document upload limits as proof of concept

### ðŸ“‹ Planned

- **Pricing Screen**: Mobile subscription management with plan selection
- **Billing Management**: Profile integration with Stripe Customer Portal
- **Entitlement System**: Feature access control based on subscriptions

## File Structure

```
apps/api/
â”œâ”€â”€ prisma/schema.prisma              # Payment models with Stripe integration
â”œâ”€â”€ src/router.ts                     # tRPC routes with Stripe API endpoints
â”œâ”€â”€ src/routes/stripe-webhooks.ts     # Complete webhook event handling
â”œâ”€â”€ src/routes/webhooks/index.ts      # Webhook routing with raw body parsing
â”œâ”€â”€ src/services/subscription.ts      # Subscription and usage service logic
â””â”€â”€ src/lib/stripe.ts                 # Stripe client configuration

apps/mobile/
â”œâ”€â”€ app/(tabs)/explore/               # Feature catalog with Stripe provider
â”œâ”€â”€ app/payments.tsx                  # Payment provider management screen
â”œâ”€â”€ components/payments/
â”‚   â”œâ”€â”€ provider-card.tsx             # Stripe provider status card
â”‚   â””â”€â”€ stripe-setup-modal.tsx       # Setup modal with state-driven UI
â”œâ”€â”€ lib/stripe.ts                     # Stripe mobile SDK initialization
â””â”€â”€ lib/hooks/
    â”œâ”€â”€ useStripeIntegration.ts       # Stripe status and test payments
    â””â”€â”€ useStripePayment.ts           # PaymentSheet integration
```

## Quick Start Guide

Ready to implement Stripe payments? Follow these guides in order:

1. **[Complete Stripe Setup](/payments/stripe-setup)** - Environment variables, ngrok, webhooks
2. **[Database Schema](/payments/database-schema)** - Understanding the payment models
3. **[Feature Catalog](/payments/feature-catalog)** - UI components and navigation

### Test Payment Flow

Once set up, you can:

1. Navigate to **Explore â†’ Payments** in the mobile app
2. See Stripe provider with "Test" status (auto-detected)
3. Click "Run Test Payment" to try the PaymentSheet
4. Use test card `4242 4242 4242 4242`
5. Check Stripe Dashboard for customer and payment records

Your payment system is production-ready with proper customer management and webhook reliability! ðŸš€
